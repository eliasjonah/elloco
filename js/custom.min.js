/**
 * РЎРѕР·РґР°РЅРёРµ DOM-СЌР»РµРјРµРЅС‚Р° РёР· СЃС‚СЂРѕРєРё
 * @param string HTML-РєРѕРґ СЌР»РµРјРµРЅС‚Р°
 * @returns {ChildNode}
 */
function createElemByString(string) {
    let template = document.createElement('template');
    template.innerHTML = string;
    return template.content.firstChild;
}

/**
 * РџСЂРµРѕР±СЂР°Р·СѓРµС‚ РїРµСЂРІС‹Р№ СЃРёРјРІРѕР» СЃС‚СЂРѕРєРё РІ РІРµСЂС…РЅРёР№ СЂРµРіРёСЃС‚СЂ
 * @param string Р’С…РѕРґРЅР°СЏ СЃС‚СЂРѕРєР°
 * @returns {string} РџСЂРµРѕР±СЂР°Р·РѕРІР°РЅРЅР°СЏ СЃСЂРѕРєР°
 */
function jsUcfirst(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

function addListener(type, selector, listener, isCapture = false) {
    document.addEventListener(type, function (e) {
        if (e.target.classList.contains(selector)) {
            listener(e);
        }
    }, isCapture);
}


$(document).ready(function() {
    var input = $('input[name="search_text"]'), timeOut;
    input.on('keyup', function () {
        clearTimeout(timeOut);
        timeOut = setTimeout(getSearch, 1000, this);
    });
    input.on('keydown', function () {
        clearTimeout(timeOut);
    });

    function getSearch(input) {
        $('.searchBox').remove();
        var searchForm = $(input).parent();

        $.ajax({
            url: $(searchForm).attr('action'),
            type: "GET", //РјРµС‚РѕРґ РѕС‚РїСЂР°РІРєРё
            dataType: "html", //С„РѕСЂРјР°С‚ РґР°РЅРЅС‹С…
            data: $(searchForm).serialize(),  // РЎРµР°СЂРёР»РёР·СѓРµРј РѕР±СЉРµРєС‚
            success: function(response) { //Р”Р°РЅРЅС‹Рµ РѕС‚РїСЂР°РІР»РµРЅС‹ СѓСЃРїРµС€РЅРѕ
                result = $.parseJSON(response);
                console.log(result);
                if ((result.products.data).length) {
                    content = '<div class="searchBox">';
                    $(result.products.data).each(function(index, product) {
                        content = content + '<div><img class="mr-3" height=50 width=50 src="/storage'+product.image+'"><a href="'+product.url+'">'+product.name+'</a></div>';
                    });
                    content = content + '<p class="text-center mt-4 mt-2"><a class="button text-white" href="'+result.url+'">РЎРјРѕС‚СЂРµС‚СЊ РІСЃРµ СЂСѓР·СѓР»СЊС‚Р°С‚С‹</a></p></div>';
                    $(searchForm).append(content);
                } else {
                    $('.searchBox').remove();
                }
            },
            error: function(response) { // Р”Р°РЅРЅС‹Рµ РЅРµ РѕС‚РїСЂР°РІР»РµРЅС‹
                alert('РџСЂРѕРёР·РѕС€Р»Р° РѕС€РёР±РєР°, РїРѕРїСЂРѕР±СѓР№С‚Рµ РїРѕР·Р¶Рµ');
            }
        });
    }
});


$(document).on('mouseover', ".js-onhover-expand", function (evnt) {
    let $el = $(this).find(".js-onhover-expand__element");

    $(this).addClass("js--hovered");
    $(this).css({zIndex : 1, height : $(this).closest(".card-wrapper").height() + $el.prop('scrollHeight') + "px"});

    $el.css({height : $el.prop('scrollHeight') + "px"});
});

$(document).on('mouseout', ".js-onhover-expand", function (evnt) {
    $(this).removeClass("js--hovered");
    $(this).css({zIndex : 0, height : $(this).closest(".card-wrapper").height() + "px"});

    let $el = $(this).find(".js-onhover-expand__element");
    $el.css({height : "0px"})
});


$(document).on('focus', ".js-onhover-expand", function (evnt) {
    $(this).addClass("js--hovered");
    $(this).css({zIndex : 1});

    let $el = $(this).find(".js-onhover-expand__element");
    $el.css({height : $el.prop('scrollHeight') + "px"})

    let $cards  = $(this).parents(".cards").find(".card");

    if ($cards.index($(this)) > 0) {
    }

});

$(document).on('blur', ".js-onhover-expand", function (evnt) {
    $(this).removeClass("js--hovered");
    $(this).css({zIndex : 0});

    let $el = $(this).find(".js-onhover-expand__element");
    $el.css({height : "0px"})
});

$(".field").bind("input", function () {
    let placeholders = $(this).prevAll('.field__placeholder');
    if ($(this).val().length === 0) {
        placeholders.eq(0).show();
    } else {
        placeholders.eq(0).hide();
    }
});

$("#addReview .rating-stars__item").bind("mouseover", function () {
    var cur_star = $(this).data('id');
    $.each( $("#addReview .rating-stars__item"), function() {
        if ($(this).data('id') <= cur_star) {
            $(this).find('svg').removeClass('star__icon--grey').addClass('star__icon--orange');
            $(this).find('use').attr('xlink:href', '#star-orange');
        } else {
            $(this).find('svg').addClass('star__icon--grey').removeClass('star__icon--orange');
            $(this).find('use').attr('xlink:href', '#star-grey');
        }
    });
    $("#addReview input[name='stars']").val(cur_star);
});

$(document).on('click', ".show_comment", function (evnt) {
    $(this).parent().find('.all_comment').removeClass('d-none');
    $(this).remove();
});

$(document).on('submit', '#addReview form', function() {
    $('.review_error').remove();
    url = $(this).attr('action');
    setTimeout($.ajax({
        url: url,
        type: "POST", //РјРµС‚РѕРґ РѕС‚РїСЂР°РІРєРё
        dataType: "html", //С„РѕСЂРјР°С‚ РґР°РЅРЅС‹С…
        data: $(this).serialize(),  // РЎРµР°СЂРёР»РёР·СѓРµРј РѕР±СЉРµРєС‚
        success: function(response) { //Р”Р°РЅРЅС‹Рµ РѕС‚РїСЂР°РІР»РµРЅС‹ СѓСЃРїРµС€РЅРѕ
            result = $.parseJSON(response);
            if (result.error) {
                $('#addReview').before('<div class="review_error alert alert-warning text-dark small">'+result.error+'</div>');
            } else {
                if (!result.login_required) {
                    $('#addReview').html('<div class="alert alert-success text-dark">Р’Р°С€ РєРѕРјРјРµРЅС‚Р°СЂРёР№ СѓСЃРїРµС€РЅРѕ РґРѕР±Р°РІР»РµРЅ Рё РѕС‚РѕР±СЂР°Р·РёС‚СЃСЏ РїРѕСЃР»Рµ РјРѕРґРµСЂР°С†РёРё.</div>');
                } else {
                    $('#loginModal').modal('toggle')
                }
            }
            console.log(result);
        },
        error: function(response) { // Р”Р°РЅРЅС‹Рµ РЅРµ РѕС‚РїСЂР°РІР»РµРЅС‹
            alert('РџСЂРѕРёР·РѕС€Р»Р° РѕС€РёР±РєР°, РїРѕРїСЂРѕР±СѓР№С‚Рµ РїРѕР·Р¶Рµ');
        }
    }), 2000);

    return false;
});

$(document).on('click', '.answer', function() {
    $(this).parent().parent().append($('#addReview'));
    $('#addReview input[name="parent_id"]').val($(this).data('id'));
    $('#add_review').show();
    $('.set_stars').hide();
    return false;
});

$(document).on('click', '#add_review', function() {
    $(this).after($('#addReview'));
    $('.set_stars').show();
    $('#addReview input[name="parent_id"]').val(0);
    return false;
});

$(document).on('click', '.useful button', function() {
    review_id = $(this).parent().data('id');
    action = $(this).data('action');
    $.ajax({
        url: $(this).parent().data('url') + '?id=' + review_id + '&action=' + action,
        type: "GET", //РјРµС‚РѕРґ РѕС‚РїСЂР°РІРєРё
        dataType: "html", //С„РѕСЂРјР°С‚ РґР°РЅРЅС‹С…
        data: [],  // РЎРµР°СЂРёР»РёР·СѓРµРј РѕР±СЉРµРєС‚
        success: function(response) { //Р”Р°РЅРЅС‹Рµ РѕС‚РїСЂР°РІР»РµРЅС‹ СѓСЃРїРµС€РЅРѕ
            result = $.parseJSON(response);
            if (result.error) {
                $('#rank_'+result.id).parent().html('<div class="text-danger small">'+result.error+'</div>');
            } else {
                if (result.rank < 0) {
                    $('#rank_'+result.id).addClass('text-danger');
                } else {
                    $('#rank_'+result.id).removeClass('text-danger');
                }
                $('#rank_'+result.id).html(result.rank);
            }
        },
        error: function(response) { // Р”Р°РЅРЅС‹Рµ РЅРµ РѕС‚РїСЂР°РІР»РµРЅС‹
            alert('РџСЂРѕРёР·РѕС€Р»Р° РѕС€РёР±РєР°, РїРѕРїСЂРѕР±СѓР№С‚Рµ РїРѕР·Р¶Рµ');
        }
    });
    return false;
});

$(".field").each(function () {
    let placeholders = $(this).prevAll('.field__placeholder');
    if ($(this).val().length === 0) {
        placeholders.eq(0).show();
    } else {
        placeholders.eq(0).hide();
    }
});
$(document).on('click', '.alert__close', function (evnt) {
    $(this).parent().hide();
});

$(document).ready(function () {
    $(".select").each(function () {
        let options = $(this).find('.select__list');

        $(this).click(function (evnt) {
            $(this).toggleClass('select--opened');

            if ($(this).hasClass("select--opened")) {
                options.css({
                    height : options.prop('scrollHeight') + "px"
                });
            } else {
                options.css({
                    height : "0px"
                });
            }
        })
    });
});

$(window).click(function (event) {
    if (! event.target.closest('.select')) {
        $(".select--opened").removeClass("select--opened");
    }
});

$(document).on('click', '.header__search .search__button', function () {
    let $search   = $(this).parents(".header__search").eq(0);

    if ($(window).width() < 767) {
        $search.toggleClass('header__search--mobile');
    }
});
$('.rating-link').click(function (event) {
    event.preventDefault();
    $(this).toggleClass("link--orangy");
    $(this).find(".burger").toggleClass("active");

    $(".page__body").toggleClass("overflowed");

    $(".category-section").toggleClass("show");
    $(".category-section-mobile").toggleClass("show");

    $("div.overflow").toggleClass("show");
    $("div.overflow").toggleClass("show-category-section");

    if ($(".category-section").hasClass("show")) {
        $(window).scrollTop(0);
    }
});

$('#loginModal').on('show.bs.modal', function (event) {
    $("div.overflow").addClass("show");
});
$('#loginModal').on('hide.bs.modal', function (event) {
    $("div.overflow").removeClass("show");
});

$(document).on('click', '.overflow.show-category-section', function () {
    $('.rating-link').trigger("click");
});
$(document).ready(function () {
    $(".rating-stars--selectable").hover(
        function (event) {
            $(this).find(".rating-stars__item");
            let $rating = $(this).closest(".rating");
        },
        function (event) {
            const value = parseInt($(this).attr('data-value'));
            $(this).find(".rating-stars__item").removeClass('rating-stars__item--selected');
            $(this).find(`.rating-stars__item:lt(${value})`).addClass('rating-stars__item--selected');

            if (value === 0) {
                $(this).closest(".rating").find(".rating-value").remove();
            } else {
                const $rating = $(this).closest(".rating").find(".rating-value");
                $rating.text(value);
                $rating.removeClass().addClass(`rating-value rating-value--${value.toFixed(1)}`);
            }


        }
    );

    $(".rating-stars--selectable .rating-stars__item").hover(function () {
        let value = parseInt($(this).data('value'));
        const $parent = $(this).closest('.rating-stars--selectable');
        const $rating = $parent.closest(".rating");

        $parent.find(".rating-stars__item").removeClass('rating-stars__item--selected');
        $parent.find(`.rating-stars__item:lt(${value})`).addClass('rating-stars__item--selected');

        if ($rating.find(".rating-value").length === 0) {
            $rating.append(`<span class='rating-value rating-value--temporary'>${value}</span>`);
        } else {
            if ($rating.find(".rating-value").hasClass("rating-value--temporary")) {
                $rating.find(".rating-value").text(value);
            } else {
                $rating.find(".rating-value").text(value).removeClass().addClass(`rating-value rating-value--${value.toFixed(1)}`);
            }

        }

    });

    $(".rating-stars--selectable .rating-stars__item").click(function () {
        const value   = parseInt($(this).data('value'));
        const $parent = $(this).closest(".rating-stars--selectable");
        const $rating = $parent.closest(".rating");

        $parent.attr('data-value', value);
        $rating.find(".rating-value").text($(this).data('value')).removeClass().addClass(`rating-value rating-value--${value.toFixed(1)}`);
    });
});


$(document).ready(function(){
    $("a[data-behavior='smooth']").on('click', function(event) {
        if (this.hash !== "") {
            //event.preventDefault();
            let hash = this.hash;
            $('html, body').animate({
                scrollTop: $(hash).offset().top
            }, 800, function(){
                window.location.hash = hash;
            });
        }
    });

    $('.js-example-basic-single').select2({
        templateSelection: formatState,
        allowClear: true,
        dropdownParent: $('.columns.twelve-columns.eight-columns-desktop')
    });
});

function formatState (state) {
    let $state = $(
        '<span>Р’С‹Р±СЂР°РЅРѕ: <span></span></span>'
    );

    $state.find("span").text($(".select2-results__option--selected").length + 1);

    return $state;
};

$('.js-example-basic-single').select2();

$('.js-example-basic-single').on('select2:closing', function( event ) {
    var $searchfield = $(this).parent().find('.select2-search.select2-search--inline');
    $searchfield.css({'display':'none'});
    $('.select2-selection__clear > span').css({'transform':'rotate(-135deg)'});
});

$('.js-example-basic-single').on('select2:opening', function( event ) {
    var $searchfield = $(this).parent().find('.select2-search.select2-search--inline');
    $searchfield.css({'display':'flex'});
    $('.select2-selection__clear > span').css({'transform':'rotate(45deg)'});
});





$(document).ready(function () {


    var swiper = new Swiper(".swiper_lastreviews_home", {
        slidesPerView: 1.05,
        spaceBetween: 16,
        grabCursor: true,
        keyboard: {
            enabled: true,
        },
        breakpoints: {
            752: {
                slidesPerView: 1.05,
                centeredSlides: false,
                spaceBetween: 16,
            },
            1264 : {
                slidesPerView: 2,
                centeredSlides: false,
                spaceBetween: 16,
            }
        },
    });

    var swiper = new Swiper(".swiper_lastproduct_home", {
        slidesPerView: 'auto',
        grabCursor: true,
        spaceBetween: 16,
    });

    var swiperImages = new Swiper(".landing-images", {
        slidesPerView: 2.05,
        spaceBetween: 10,
        containerModifierClass : 'landing-images',
        wrapperClass : 'landing-images-wrapper',
        slideClass : 'landing-image',
        slideToClickedSlide : false,
        breakpoints: {
            752: {
                slidesPerView: 3,
                centeredSlides: false,
                spaceBetween: 16,
            },
            1264 : {
                slidesPerView: 4,
                centeredSlides: false,
                spaceBetween: 16,
            }
        },
    });


    var swiperProduct = new Swiper('.product__gallery', {
        spaceBetween: 0,
        centeredSlides: true,
        pagination: {
            el: '.product__gallery-pagination',
        },
        navigation: {
            nextEl: '.product__gallery-button-next',
            prevEl: '.product__gallery-button-prev',
        },
    });
});


$('ul.menu > .menu__item').click(function() {
    var id = $(this).data('id');
    $('.category-section__submenu.active').removeClass('active');
    $(this).parent().parent().parent().parent().find('.cat_' + id).addClass('active');
});

$('.sitemap ul.menu > .menu__item').click(function() {
    var id = $(this).data('id');
    $('.category-section__submenu.active').removeClass('active');
    $(this).parent().parent().parent().parent().find('.cat_' + id).addClass('active');
});

$('.menu__item > .menu__link').click(function() {
    var id = $(this).data('id');
    $(this).parent().find('.cat_' + id).css({'left': '0'}).removeClass('d-none');
    $('.category-section-mobile__caption').html('<span role="button" class="link--primary-theme backbutton mr-2 px-2">вЂ№</span>' + $(this).text());

    $('.backbutton').click(function() {
        $('.menu__item ul.menu').css({'left': '100%'}).addClass('d-none');
        $('.category-section-mobile__content > .category-section-mobile__caption').text('Р РµР№С‚РёРЅРі С‚РѕРІР°СЂРѕРІ');
    });
});